<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="nas-inputs.html">
<link rel="import" href="../bower_components/file-fire/file-fire-drop.html">
<link rel="import" href="nas-cards.html">
<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">

<dom-module id="nas-profile">
  <template>
    <style include="paper-material-styles">
       :host {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
      }

      file-fire-drop-multi {
        margin: 5px;
      }

      file-fire-drop {
        height: 100px;
        width: 100px;
        border-radius: 4px;
        --file-fire-dropzone-background-image: url("http://i.imgur.com/ndcWzqn.png");
      }

      .logo {
        width: 200px;
        height: 200px;
        flex: 0 0 auto;
      }

      paper-card .card-content>div {
        display: flex;
        flex-direction: row;
      }

      paper-card .card-content>div[hidden] {
        display: none !important;
      }

      paper-card .card-actions {
        display: flex;
        justify-content: flex-end;
      }

      paper-card {
        width: 66%;
      }

      .basics > * {
        padding: 5px;
      }

      .basics {
        display: flex;
        flex-wrap: wrap;
      }

      .menu {
        width: 150px;
        height: 207px;
        @apply --paper-material-elevation-1;
      }

      .banner {
        width: 207px;
        height: 110px;
        @apply --paper-material-elevation-1;
      }

      .times-output {
        display: flex;
      }

      .times-output>* {
        padding: 5px;
      }
      paper-textarea {
        min-width:300px;
        max-width:450px;
      }
    </style>
    <paper-card heading="Profile - [[profileHeading]]">
      <div class="card-actions">
        <paper-button edit on-tap="toggleEdit">Edit</paper-button>
      </div>
      <div class="card-content">
        <div hidden$="[[editing]]" style="display:flex;flex-direction:column">
          <div style="display:flex;flex-direction:row">
            <iron-image src="[[data.logo]]" class="logo"
              sizing="contain" style="background:light-grey">
            </iron-image>
            <div class="basics">
              <div>
                <h3 style="display:inline-block;">[[data.name]]</h3>,<i>Level [[data.level]], Building [[data.building]], [[data.address]]</i>
                <br>
                <iron-icon icon="av:web"></iron-icon>
                <a hidden$="[[!data.website]]" href$="[[data.website]]">
                    [[data.website]]
                </a>
                <div>[[data.tagline]]</div>
                <p><i>Detail: </i>[[data.detail]]</p>
              </div>
            </div>
          </div>
          <h3>Operating Hours</h3>
          <div class="times-output">
            <multi-time-range-output times="[[data.operating_hours]]"></multi-time-range-output>
          </div>
          <div hidden$="[[!data.banners]]">
            <h3>Banner Images</h3>
            <template id="menus" is="dom-repeat" items="[[data.banners]]">
              <iron-image class="banner" sizing="contain" preload
                src="[[item.src]]" alt="[[item.alt]]"></iron-image>
            </template>
          </div>
          <div hidden$="[[!data.menus]]">
            <h3>Menu Images</h3>
            <template id="banners" is="dom-repeat" items="[[data.menus]]">
              <iron-image class="menu" sizing="contain" preload
                src="[[item.src]]" alt="[[item.alt]]"></iron-image>
            </template>
          </div>
        </div>
        <div id="edit" hidden$="[[!editing]]" style="display:flex;flex-direction:column">
          <div id="basic-section" style="display:flex;flex-direction:row">
            <file-fire-drop class="logo" app-name="[[appName]]"
              path="/[[retailer]]/logo" src-file over-write
              max-dimension="200" progress="{{progress}}"
              placeholder="{{base64}}" files="{{images}}"
              always-show on-upload="recordLogo" name="logo"
            >
            </file-fire-drop>
            <div>
              <div class="basics">
                <div style="display:inline-block;">
                  <paper-input name="name" value="{{name}}"
                    required auto-validate
                    label='Name *'
                  ></paper-input>
                  <paper-tooltip offset="0">Your trading name</paper-tooltip>
                </div>
                <div style="display:inline-block">
                  <paper-input name="building" value="{{building}}" 
                    required auto-validate type="number"
                    label="Building">
                  </paper-input>
                  <paper-tooltip offset="0">If you're within 5-10m of one, please list it</paper-tooltip>
                </div>
                <div style="display:inline-block">
                  <paper-input name="level" level="{{level}}"
                    required auto-validate type="number"
                    label="Level *">
                  </paper-input>
                  <paper-tooltip offset="0">Don't list if you're not inside</paper-tooltip>
                </div>
                <div style="display:inline-block">
                  <paper-input name="address" value="{{address}}"
                    required auto-validate
                    label='Address *'
                  ></paper-input>
                  <paper-tooltip offset="0"></paper-tooltip>
                </div>
                <div style="display:inline-block">
                  <paper-input name="website" value="{{website}}"
                    label='Website (optional)'
                  ></paper-input>
                  <paper-tooltip offset="0">If you have one</paper-tooltip>
                </div>
                <div style="display:inline-block">
                  <paper-input name="tagline" char-counter maxlength="25"
                    required auto-validate value="{{tagline}}"
                    label='Tagline *'
                  ></paper-input>
                  <paper-tooltip offset="0">A <i>very</i> short description - e.g. Hip Burger Joint</paper-tooltip>
                </div>
              </div>
              <div style="display:inline-block">
                <paper-textarea name="detail" char-counter maxlength="256"
                  required auto-validate value="{{detail}}"
                  always-float-label
                  label='Detail *'
                ></paper-textarea>
                <paper-tooltip offset="0" position="top">A longer description of your establishment</paper-tooltip>
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column">
            <file-fire-drop-multi id="menus-input" uploaded-images="{{menuImages}}" app-name="[[appName]]" prefix="[[retailer]]/menu" label="Menu Images"></file-fire-drop-multi>
            <paper-tooltip for="menus-input" offset="0">Upload up to 7 menu images</paper-tooltip>
            <file-fire-drop-multi id="banners-input" uploaded-images="{{bannerImages}}" app-name="[[appName]]" prefix="[[retailer]]/banner" label="Carousel Images"></file-fire-drop-multi>
            <paper-tooltip for="banners-input" offset="0">Upload up to 7 banner images</paper-tooltip>
            <h3>Operating Hours</h3>
            <div style="display:flex;flex-wrap:wrap;justify-content:center;">
              <template is="dom-repeat" items="[[weekdays]]">
                <div id$="hours-[[item.name]]" hidden$="[[item.disabled]]" style="display:flex;flex-direction:column;align-items:center;position:relative;">
                  <h3>[[item.name]]</h3>
                  <paper-icon-button icon="delete" day="[[item.name]]" on-tap="deleteDay" style="position:absolute;top:0;right:0"></paper-icon-button>
                  <time-range-input style="flex-direction:column"
                    start-time$="[[item.startTime]]"
                    end-time$="[[item.endTime]]"
                    name$="[[item.name]]"
                  ></time-range-input>
                </div>
                <paper-tooltip for$="hours-[[item.name]]" offset="0">Specify opening and closing times for [[item.name]]</paper-tooltip>
              </template>
            </div>
            <paper-button on-tap="submitProfileChanges" disabled$="[[!filledOut]]" hidden$="[[!editing]]">Save</paper-button>
          </div>
        </div>
      </div>

    </paper-card>

  </template>
  <script>
    class NasProfile extends Polymer.Element {
      static get is() {
        return 'nas-profile';
      }
      static get properties() {
        return {
          appName: {
            type: String,
            reflectToAttribute: true
          },
          editing: {
            type: Boolean,
            value: () => false
          },
          profileHeading: {
            type: String,
            computed: 'computeHeading(data.name)'
          },
          filledOut: {
            type: Boolean,
            computed: 'computeFilled(name,address,tagline,detail,logo,awaitingImages)'
          },
          awaitingImages: {
            type: Boolean,
            value: () => false
          },
          weekdays: {
            type: Array,
            value: () => {
              return [
                {name: 'MON'}, {name: 'TUES'}, {name: 'WED'},
                {name: 'THURS'}, {name: 'FRI'}, {name: 'SAT'},
                {name: 'SUN'}
              ]
            }
          },
          data: {
            type: Object
          }
        }
      }
      computeFilled(name,address,tagline,detail,logo,awaitingImages) {
        return name && address && tagline && detail && logo && !awaitingImages;
      }
      deleteDay(e) {
        let day = e.target.day;
        let idx = this.weekdays.findIndex(elem => elem.name == day);
        this.set(`weekdays.${idx}.startTime`, "");
        this.set(`weekdays.${idx}.endTime`, "");
      }
      computeHeading(name) {
        return name ? name : 'New Retailer';
      }
      toggleEdit() {
        this.editing = !this.editing;
        Object.keys(this.data).forEach((k) => {
          let elem = this.shadowRoot.getElementById('edit').querySelector(`[name="${k}"]`);
          
          if (typeof this.data[k] == "string") {
            if(!elem) return;
            elem.value = this.data[k];
          }

          if(k == "operating_hours") {
            for(let i in this.data[k]) {
              let day = this.data[k][i];
              let name = day.name;
              this.set(`weekdays.${i}.startTime`,day.start_time);
              this.set(`weekdays.${i}.endTime`, day.end_time);
            }
          }
          if(k == 'banners') {
            this.set('bannerImages',this.data[k])
          }
          if(k == 'menus') {
            this.set('menuImages', this.data[k]);
          }
          if(k == 'logo') {
            this.set('logo', this.data[k]);
            this.shadowRoot.querySelector('file-fire-drop').updateStyles(
              {"--file-fire-dropzone-background-image": `url(${this.data[k]})`});
          }
          
        })
      }

      recordLogo(e) {
        this.set('logo', e.detail.urls[0].url);
        this.shadowRoot.querySelector('file-fire-drop').updateStyles(
          {"--file-fire-dropzone-background-image": `url(${this.logo})`});
      }
      submitProfileChanges() {
        let formRoot = this.shadowRoot.getElementById('edit');
        let fields = Array.from(formRoot.querySelectorAll('div > div.basics')).reduce((a, b) => {
          return a.concat(Array.from(b.children))
        }, []);
        let formData = fields.filter((elem) => {
          return elem.hasAttribute('name')
        }).map((elem) => {
          let obj = {};
          obj[elem.name] = elem.value;
          return obj;
        }).reduce((a, b) => Object.assign(a, b), {});
        // TODO: grab all the images and special inputs
        let timeRangeData = Array.from(formRoot.querySelectorAll('time-range-input')).map((elem) => {
          return {
            start_time: elem.startTime,
            end_time: elem.endTime,
            name: elem.name
          };
        }).filter((rangeObj) => {
          return rangeObj.start_time && rangeObj.end_time && rangeObj.name;
        });
        console.log(formRoot);
        formData['menus'] = this.shadowRoot.getElementById('menus-input').uploadedImages;
        formData['banners'] = this.shadowRoot.getElementById('banners-input').uploadedImages;
        if(this.logo) {
          formData['logo'] = this.logo;
        }
        
        formData['operating_hours'] = timeRangeData;
        this.dispatchEvent(new CustomEvent('update-profile', {
          detail: formData,
          bubbles: true,
          composed: true
        }));
        this.toggleEdit();
      }
    }

    window.customElements.define(NasProfile.is, NasProfile);
  </script>
</dom-module>