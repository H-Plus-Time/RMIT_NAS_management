box: justinribeiro/lighthouse
build:
  steps:
    - script:
        name: install yarn, git
        code: |
          apt-get update && apt-get install -y git && npm install -g yarn
    - script:
        name: set yarn cache
        code: |
          export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
    - script:
        name: install dependencies
        code: |
          HOME=$YARN_CACHE yarn && yarn global add bower polymer-cli firebase-tools
    - script:
        name: bower install
        code: |
          bower install --allow-root --config.interactive=false
    - script:
        name: actual build
        code: |
          polymer build
deploy:
  steps:
    - script:
        name: firebase deploy --token "$FIREBASE_KEY"
        code: |
          firebase deploy --project=nas-app
    - script:
        name: lighthouse audit
        code: |
          mkdir report && cp README.md report
          headless_shell --no-sandbox --remote-debugging-port=9222 &>1 &
          lighthouse https://nas-app.firebaseapp.com --output json --output-path=report/lighthouse_results.json
          lighthouse https://nas-app.firebaseapp.com --output html --output-path=build/default/audit.html
    - script:
        name: deploy with audit results
        code: firebase deploy --project=nas-app